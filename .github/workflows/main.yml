name: Diabetes CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  train-and-build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Setup Python
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # 3. Install Dependencies
      # Kita install manual agar --env-manager=local bisa jalan
      - name: Install Libraries
        run: |
          pip install mlflow pandas scikit-learn matplotlib seaborn joblib

      # 4. Execute MLflow Run (Training)
      # PERBAIKAN: Menggunakan --env-manager=local
      - name: Train Model
        run: |
          cd MLProject
          mlflow run . --env-manager=local --experiment-name CI_Diabetes_Run

      # 5. Archive Artifacts (Syarat Skilled)
      - name: Upload MLflow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: training-artifacts
          path: MLProject/mlruns

      # 6. Build & Push Docker Image (Syarat Advance)
      - name: Build and Push Docker Image
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PWD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          cd MLProject
          # Ambil Run ID terbaru
          EXP_ID=$(ls mlruns | grep -E '^[0-9]+$' | head -n 1)
          RUN_ID=$(ls -t mlruns/$EXP_ID | head -n 1)

          echo "Found Experiment ID: $EXP_ID"
          echo "Found Run ID: $RUN_ID"

          # Login Docker
          echo $DOCKER_PWD | docker login -u $DOCKER_USER --password-stdin

          # Build Docker
          mlflow models build-docker \
            -m "runs:/$RUN_ID/model" \
            -n "$DOCKER_USER/diabetes-prediction:v1" \
            --enable-mlserver

          # Push
          docker push "$DOCKER_USER/diabetes-prediction:v1"
